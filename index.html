async function fetchETA(stopId) {
    const box = document.getElementById(`eta-container-${stopId}`);
    try {
        // 加入時間戳防止 iPhone 讀取舊的快取資料
        const resp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}?t=${Date.now()}`);
        const json = await resp.json();
        
        const routes = {};
        // 1. 先按路線編號排序，確保不同裝置顯示順序一致
        const sortedData = json.data.sort((a, b) => a.route.localeCompare(b.route, undefined, {numeric: true}));

        sortedData.forEach(item => {
            if (!item.eta) return; // 沒時間的不顯示
            if (!routes[item.route]) routes[item.route] = [];
            // 每個路線最多顯示 3 班
            if (routes[item.route].length < 3) {
                routes[item.route].push(item);
            }
        });

        const html = Object.values(routes).map(bus => {
            // 確保同一個路線的班次是按時間先後排列
            bus.sort((a, b) => new Date(a.eta) - new Date(b.eta));

            return `
                <div class="flex justify-between items-center py-2 px-2 border-b border-slate-50 last:border-0">
                    <div class="flex items-center gap-2">
                        <span class="bg-slate-800 text-white font-black px-2 py-0.5 rounded text-[11px] min-w-[3.5rem] text-center">${bus[0].route}</span>
                        <span class="text-[11px] text-slate-500 truncate w-24">往${bus[0].dest_tc}</span>
                    </div>
                    <div class="flex items-center text-sm gap-1">
                        ${bus.map(b => {
                            const etaTime = new Date(b.eta).getTime();
                            const nowTime = Date.now();
                            let m = Math.floor((etaTime - nowTime) / 60000);
                            if (isNaN(m)) return `<span class="text-slate-300 text-[10px]">--</span>`;
                            m = Math.max(0, m);
                            const color = m <= 5 ? 'text-red-600 font-bold' : 'text-emerald-600 font-bold';
                            return `<span class="${color}">${m}<small class="text-[9px] font-normal">分</small></span>`;
                        }).join('<span class="text-slate-200">|</span>')}
                    </div>
                </div>
            `;
        }).join('');

        box.innerHTML = html || '<p class="text-xs text-center text-slate-300 py-2">暫無班次</p>';
    } catch (e) { 
        console.error(e);
        box.innerHTML = '<p class="text-[10px] text-red-300 text-center">連線中斷</p>'; 
    }
}
