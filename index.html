<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹å·´åˆ°ç«™ PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .eta-card { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input[type="search"] { -webkit-appearance: none; border-radius: 12px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-12">

    <header class="bg-red-600 text-white p-4 sticky top-0 shadow-lg z-30">
        <div class="max-w-md mx-auto space-y-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold tracking-tight">KMB å¯¦æ™‚åˆ°ç«™</h1>
                <button onclick="getLocation()" class="bg-white text-red-600 text-xs px-4 py-2 rounded-full font-bold shadow-sm active:scale-95 transition-all">ğŸ“ é™„è¿‘è»Šç«™</button>
            </div>
            <div class="relative">
                <input type="search" id="searchInput" placeholder="æœå°‹è»Šç«™ (ä¾‹å¦‚: å°–æ²™å’€, 968)..." 
                    class="w-full p-3 pl-4 rounded-xl text-slate-900 text-sm border-none outline-none shadow-inner focus:ring-2 focus:ring-red-300">
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <div id="status" class="text-center text-[10px] text-slate-400 mb-4 tracking-widest uppercase font-medium">ç³»çµ±æº–å‚™ä¸­...</div>
        
        <div id="loader" class="hidden text-center py-6">
            <div class="animate-spin inline-block w-6 h-6 border-4 border-red-500 border-t-transparent rounded-full"></div>
        </div>

        <div id="stop-list" class="space-y-4">
            </div>
    </main>

    <script>
        const DB_NAME = "KMB_DB_V2";
        const STORE_NAME = "stops";
        let db = null;
        let activeStopIds = [];
        let autoRefreshTimer = null;

        // 1. åˆå§‹åŒ– IndexedDB (å°è£æˆ Promise ä»¥ç¢ºä¿åŒæ­¥)
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "stop" });
                    }
                };
                request.onsuccess = e => { db = e.target.result; resolve(db); };
                request.onerror = e => reject("DB Error");
            });
        }

        // 2. å•Ÿå‹•ç¨‹åº
        window.onload = async () => {
            try {
                await initDB();
                await checkAndDownloadData();
                setupSearch();
            } catch (err) {
                document.getElementById('status').innerText = "å•Ÿå‹•å¤±æ•—: " + err;
            }
        };

        async function checkAndDownloadData() {
            const lastUpdate = localStorage.getItem('kmb_last_update');
            const now = Date.now();
            const ONE_DAY = 24 * 60 * 60 * 1000;

            if (!lastUpdate || (now - lastUpdate > ONE_DAY)) {
                document.getElementById('status').innerText = "æ­£åœ¨åŒæ­¥é›¢ç·šè»Šç«™è³‡æ–™ (2MB)...";
                try {
                    const resp = await fetch("https://data.etabus.gov.hk/v1/transport/kmb/stop");
                    const json = await resp.json();
                    
                    const tx = db.transaction(STORE_NAME, "readwrite");
                    const store = tx.objectStore(STORE_NAME);
                    await store.clear();
                    json.data.forEach(s => store.put(s));
                    
                    localStorage.setItem('kmb_last_update', now);
                    document.getElementById('status').innerText = "è³‡æ–™åŒæ­¥å®Œæˆ";
                } catch (e) {
                    document.getElementById('status').innerText = "ç¶²çµ¡ç•°å¸¸ï¼Œä½¿ç”¨èˆŠè³‡æ–™";
                }
            } else {
                document.getElementById('status').innerText = "é›¢ç·šç·©å­˜æ¨¡å¼ (æ¯ 24h æ›´æ–°)";
            }
        }

        // 3. æœå°‹é‚è¼¯ (åŠ ä¸Š Debounce é˜²æ­¢ UI å‡çµ)
        function setupSearch() {
            let timeout = null;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(timeout);
                const query = e.target.value.trim().toUpperCase();
                if (query.length < 2) {
                    document.getElementById('stop-list').innerHTML = '';
                    return;
                }
                timeout = setTimeout(() => execSearch(query), 400);
            });
        }

        async function execSearch(query) {
            document.getElementById('loader').classList.remove('hidden');
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const results = [];

            store.openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const s = cursor.value;
                    if (s.name_tc.includes(query) || s.name_en.toUpperCase().includes(query)) {
                        results.push(s);
                    }
                    if (results.length < 10) cursor.continue(); // æœ€å¤šé¡¯ç¤º 10 å€‹ï¼Œæ•ˆèƒ½æœ€ä½³
                    else finalizeSearch(results);
                } else {
                    finalizeSearch(results);
                }
            };
        }

        function finalizeSearch(results) {
            document.getElementById('loader').classList.add('hidden');
            renderStops(results, false);
        }

        // 4. GPS é™„è¿‘è»Šç«™
        function getLocation() {
            document.getElementById('loader').classList.remove('hidden');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const tx = db.transaction(STORE_NAME, "readonly");
                const store = tx.objectStore(STORE_NAME);
                let list = [];
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                store.openCursor().onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        const s = cursor.value;
                        const d = Math.sqrt((s.lat-lat)**2 + (s.long-lon)**2); // ç°¡åŒ–è·é›¢ç®—æ³•æå‡æ•ˆèƒ½
                        list.push({...s, d});
                        cursor.continue();
                    } else {
                        list.sort((a,b) => a.d - b.d);
                        document.getElementById('loader').classList.add('hidden');
                        renderStops(list.slice(0, 3), true);
                    }
                };
            }, () => { alert("è«‹é–‹å•Ÿ GPS æ¬Šé™"); document.getElementById('loader').classList.add('hidden'); });
        }

        // 5. UI æ¸²æŸ“èˆ‡ ETA
        function renderStops(stops, isGPS) {
            const container = document.getElementById('stop-list');
            container.innerHTML = '';
            activeStopIds = stops.map(s => s.stop);

            stops.forEach(stop => {
                const card = document.createElement('div');
                card.className = "eta-card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden";
                card.innerHTML = `
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                        <div class="truncate">
                            <h2 class="font-bold text-slate-800 text-sm">${stop.name_tc}</h2>
                            <p class="text-[10px] text-slate-400 uppercase tracking-tighter">${stop.name_en}</p>
                        </div>
                        <div class="text-[9px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded">LIVE</div>
                    </div>
                    <div id="eta-container-${stop.stop}" class="p-2 min-h-[40px]">
                        <div class="flex justify-center py-2"><div class="animate-pulse h-2 w-20 bg-slate-200 rounded"></div></div>
                    </div>
                `;
                container.appendChild(card);
                fetchETA(stop.stop);
            });

            // é‡å•Ÿè‡ªå‹•æ›´æ–°å®šæ™‚å™¨
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(() => {
                activeStopIds.forEach(id => fetchETA(id));
            }, 30000);
        }

        async function fetchETA(stopId) {
            const box = document.getElementById(`eta-container-${stopId}`);
            try {
                const resp = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${stopId}`);
                const json = await resp.json();
                
                const routes = {};
                json.data.forEach(item => {
                    if (!routes[item.route]) routes[item.route] = [];
                    if (routes[item.route].length < 3) routes[item.route].push(item);
                });

                const html = Object.values(routes).map(bus => `
                    <div class="flex justify-between items-center py-2 px-2 border-b border-slate-50 last:border-0">
                        <div class="flex items-center gap-2">
                            <span class="bg-slate-800 text-white font-black px-2 py-0.5 rounded text-[11px] min-w-[3rem] text-center">${bus[0].route}</span>
                            <span class="text-[11px] text-slate-500 truncate w-24">å¾€${bus[0].dest_tc}</span>
                        </div>
                        <div class="flex items-center text-sm">
                            ${bus.map(b => {
                                const m = Math.max(0, Math.floor((new Date(b.eta) - Date.now()) / 60000));
                                const color = m <= 5 ? 'text-red-600 font-bold' : 'text-emerald-600 font-bold';
                                return `<span class="${color}">${isNaN(m) ? '--' : m}<small class="text-[10px] font-normal">åˆ†</small></span>`;
                            }).join('<span class="text-slate-200 px-1">|</span>')}
                        </div>
                    </div>
                `).join('');

                box.innerHTML = html || '<p class="text-xs text-center text-slate-300 py-2">æš«ç„¡ç­æ¬¡</p>';
                document.getElementById('status').innerText = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}`;
            } catch (e) { box.innerHTML = '<p class="text-[10px] text-red-300">é€£ç·šè¶…æ™‚</p>'; }
        }
    </script>
</body>
</html>